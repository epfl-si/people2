#!/usr/bin/env bash

# Bend over backwards for the impatient developer, and install the
# dependencies and set up the database on their behalf. This is *not*
# an attempt to hot-update these moving parts everytime you modify
# their source files (i.e. `Gemfile`, `package.json` or
# `db/migrate/*`):
NODE_MODULES_PATH=${NODE_MODULES:-node_modules}
BUNDLE_PATH=${BUNDLE_PATH:-vendor/bundle}

[ -d $NODE_MODULES_PATH ] || ./bin/bundle
[ -d NODE_MODULES_PATH ] || yarn


echo "here is the content of db:"
ls -l db

# [ -f db/development.sqlite3 ] || ./bin/rails db:migrate db:seed

echo "Starting rails server on PORT: '$PORT', ADDR: '$ADDR'"

if [ -f /app/tmp/pids/server.pid ] ; then
	if [ "$KILLPID" == "yes" ] ; then
		rm /app/tmp/pids/server.pid 
	fi
fi

# cd "$(dirname "$0")/.."
node_modules/.bin/concurrently -c red,blue -n puma,esbuild "./bin/rails server -p ${PORT:-3000} -b ${ADDR:-127.0.0.1}" "yarn build --watch"
